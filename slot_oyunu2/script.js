// DOM Elementlerini Se√ß
const reels = document.querySelectorAll('.reel');
const spinButton = document.getElementById('spinButton');
const autoSpinButton = document.getElementById('autoSpinButton'); // Yeni: Otomatik √áevirme Butonu
const autoSpinInput = document.getElementById('autoSpinCount'); // Yeni: Otomatik √áevirme Sayƒ±sƒ± Inputu
const messageDisplay = document.getElementById('message');
const balanceDisplay = document.getElementById('balance');
const betAmountDisplay = document.getElementById('betAmount');
const winAmountDisplay = document.getElementById('winAmount');
const freeSpinsCountDisplay = document.getElementById('freeSpinsCount');

const decreaseBetBtn = document.getElementById('decreaseBet');
const increaseBetBtn = document.getElementById('increaseBet');
const infoButton = document.getElementById('infoButton');
const infoPopup = document.getElementById('infoPopup');
const closeInfoPopupBtn = document.getElementById('closeInfoPopup');
const paytableInfoDisplay = document.getElementById('paytableInfo');
const muteButton = document.getElementById('muteButton');
const backToLobbyButton = document.getElementById('backToLobbyButton');

// Yeni: √ñdeme √áizgisi Ayarlarƒ± DOM Elementleri
const paylineSettingsButton = document.getElementById('paylineSettingsButton');
const paylineSettingsPopup = document.getElementById('paylineSettingsPopup');
const closePaylineSettingsPopupBtn = document.getElementById('closePaylineSettingsPopup');
const paylineOptionsGrid = document.getElementById('paylineOptions');
const savePaylineSettingsBtn = document.getElementById('savePaylineSettings');

// Ses Elementleri (Doƒürudan JavaScript i√ßinde olu≈üturuldu ve Zeus isimleri kullanƒ±ldƒ±)
const backgroundMusic = new Audio('../assets/sounds/zeus_background_music.mp3');
const spinSound = new Audio('../assets/sounds/zeus_spin.mp3');
const winSound = new Audio('../assets/sounds/zeus_win.mp3');
const bonusSound = new Audio('../assets/sounds/zeus_bonus.mp3'); // Bonus Zeus sesi i√ßin

// Oyun Deƒüi≈ükenleri
let activeUser = localStorage.getItem('hansellCasinoActiveUser');
let users = JSON.parse(localStorage.getItem('hansellCasinoUsers')) || {};

// Eƒüer aktif kullanƒ±cƒ± yoksa veya kullanƒ±cƒ± verisi hatalƒ±ysa, lobiye geri y√∂nlendir
if (!activeUser || !users[activeUser]) {
    alert('Oturum s√ºresi doldu veya kullanƒ±cƒ± bulunamadƒ±. L√ºtfen tekrar giri≈ü yapƒ±n.');
    window.location.href = '../index.html'; // Ana giri≈ü sayfasƒ±na y√∂nlendir
}

// Kullanƒ±cƒ±nƒ±n ki≈üisel bakiyesi
let balance = users[activeUser].balance;
let betAmount = 10;
let isSpinning = false;
let highlightTimeout;
let symbolResetTimeout;
let lastSpinSymbols = [];
let freeSpins = 0; // Free spinler kullanƒ±cƒ±nƒ±n bakiyesinden baƒüƒ±msƒ±zdƒ±r

// Otomatik √áevirme Deƒüi≈ükenleri
let isAutoSpinning = false;
let autoSpinCount = 0; // Otomatik √ßevrilecek spin sayƒ±sƒ±
let currentAutoSpin = 0; // Mevcut √ßevrilen spin sayƒ±sƒ±
let autoSpinTimeout; // Spinler arasƒ± bekleme i√ßin timeout

// Ses Seviyeleri ve Durum
let isMuted = false;

// Ses seviyelerini ayarla (varsayƒ±lan olarak kƒ±sƒ±k ba≈ülar)
backgroundMusic.volume = 0.2; // Arkaplan m√ºziƒüinin sesini biraz kƒ±sƒ±k tut
spinSound.volume = 0.6;
winSound.volume = 0.8;
bonusSound.volume = 0.9;

backgroundMusic.loop = true; // Arkaplan m√ºziƒüi s√ºrekli d√∂ns√ºn

// YENƒ∞: Slot Sembolleri Tanƒ±mlarƒ± (Zeus Temasƒ±)
const symbols = [
    { id: 'zeus', img: '../assets/images/symbol_zeus.png', value: 100 },
    { id: 'pegasus', img: '../assets/images/symbol_pegasus.png', value: 80 },
    { id: 'eagle', img: '../assets/images/symbol_eagle.png', value: 60 },
    { id: 'helmet', img: '../assets/images/symbol_helmet.png', value: 40 },
    { id: 'vase', img: '../assets/images/symbol_vase.png', value: 30 },
    { id: 'coin', img: '../assets/images/symbol_coin.png', value: 20 },
    { id: 'thunder', img: '../assets/images/symbol_thunder.png', value: 15 },
    { id: 'cardA', img: '../assets/images/symbol_card_a.png', value: 10 },
    { id: 'cardK', img: '../assets/images/symbol_card_k.png', value: 8 },
    { id: 'cardQ', img: '../assets/images/symbol_card_q.png', value: 6 },
    { id: 'cardJ', img: '../assets/images/symbol_card_j.png', value: 4 },
    { id: 'zeus_scatter', img: '../assets/images/zeus_scatter.png' }, // Free Spin bonus sembol√º (ID VE RESƒ∞M YOLU G√úNCEL)
    { id: 'bonus_3x', img: '../assets/images/bonus_3x.png', multiplier: 3 },
    { id: 'bonus_5x', img: '../assets/images/bonus_5x.png', multiplier: 5 },
    { id: 'bonus_10x', img: '../assets/images/bonus_10x.png', multiplier: 10 },
    { id: 'bonus_20x', img: '../assets/images/bonus_20x.png', multiplier: 20 },
    { id: 'bonus_50x', img: '../assets/images/bonus_50x.png', multiplier: 50 },
    { id: 'bonus_100x', img: '../assets/images/bonus_100x.png', multiplier: 100 },
    { id: 'bonus_1000x', img: '../assets/images/bonus_1000x.png', multiplier: 1000 }
];

// Sembol ID'lerini resim yollarƒ±na e≈üleyen map olu≈ütur
const symbolImagesMap = new Map(symbols.map(s => [s.id, s.img]));

// Sembollerin nadirlik aƒüƒ±rlƒ±klarƒ± (bonuslar hari√ß - onlar ayrƒ± ele alƒ±nacak)
// KAZAN√á OLASILIƒûI ARTIRILDI: Deƒüerli sembollerin tekrar sayƒ±larƒ± y√ºkseltildi
const weightedSymbols = [
    'zeus', 'zeus', 'zeus', 'zeus', 'zeus', // Zeus daha sƒ±k gelsin (5 adet - √ñNCE 4 ADETTƒ∞)
    'pegasus', 'pegasus', 'pegasus', 'pegasus', 'pegasus', 'pegasus', // Pegasus daha sƒ±k (6 adet - √ñNCE 5 ADETTƒ∞)
    'eagle', 'eagle', 'eagle', 'eagle', 'eagle', 'eagle', 'eagle', // Eagle daha sƒ±k (7 adet - √ñNCE 6 ADETTƒ∞)
    'helmet', 'helmet', 'helmet', 'helmet', 'helmet', 'helmet', 'helmet', 'helmet', 'helmet', // Helmet daha da sƒ±k (9 adet - √ñNCE 8 ADETTƒ∞)
    'vase', 'vase', 'vase', 'vase', 'vase', 'vase', 'vase', 'vase', 'vase', // Vase daha da sƒ±k (9 adet - √ñNCE 8 ADETTƒ∞)
    'coin', 'coin', 'coin', 'coin', 'coin', 'coin', 'coin', 'coin', 'coin', 'coin', 'coin', // Coin √ßok daha sƒ±k (11 adet - √ñNCE 10 ADETTƒ∞)
    'thunder', 'thunder', 'thunder', 'thunder', 'thunder', 'thunder', 'thunder', 'thunder', 'thunder', 'thunder', 'thunder', // Thunder √ßok daha sƒ±k (11 adet - √ñNCE 10 ADETTƒ∞)
    'cardA', 'cardA', 'cardA', 'cardA', 'cardA', 'cardA', 'cardA', 'cardA', 'cardA', 'cardA', 'cardA', 'cardA', 'cardA', // CardA biraz daha az (13 adet - √ñNCE 12 ADETTƒ∞ - Dengelemek i√ßin biraz artƒ±rdƒ±m ama diƒüerleri daha √ßok arttƒ±)
    'cardK', 'cardK', 'cardK', 'cardK', 'cardK', 'cardK', 'cardK', 'cardK', 'cardK', 'cardK', 'cardK', 'cardK', 'cardK', // CardK biraz daha az (13 adet - √ñNCE 12 ADETTƒ∞)
    'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', 'cardQ', // CardQ hala sƒ±k (15 adet - √ñNCE 14 ADETTƒ∞)
    'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ', 'cardJ'  // CardJ hala sƒ±k (15 adet - √ñNCE 14 ADETTƒ∞)
];

// Free Spin bonus sembollerini ayrƒ± bir weighted listeye ekle
// ZEUS SCATTER GELME OLASILIƒûI ARTIRILDI!
const weightedFreeSpinSymbols = [
    'zeus_scatter', 'zeus_scatter', 'zeus_scatter', 'zeus_scatter', 'zeus_scatter', 'zeus_scatter', 'zeus_scatter' // Free spin sembol√º daha da sƒ±k gelsin (7 adet - √ñNCE 5 ADETTƒ∞)
];

// √áarpan sembollerini ayrƒ± bir weighted listeye ekle (daha d√º≈ü√ºk √ßarpanlarƒ±n gelme olasƒ±lƒ±ƒüƒ± artƒ±rƒ±ldƒ±, y√ºksekler nadirle≈ütirildi)
const weightedMultiplierSymbols = [
    'bonus_3x', 'bonus_3x', 'bonus_3x', 'bonus_3x', 'bonus_3x', 'bonus_3x', 'bonus_3x', 'bonus_3x', // 3x daha da √ßok sƒ±k (8 adet - √ñNCE 6 ADETTƒ∞)
    'bonus_5x', 'bonus_5x', 'bonus_5x', 'bonus_5x', 'bonus_5x', // 5x daha sƒ±k (5 adet - √ñNCE 4 ADETTƒ∞)
    'bonus_10x', 'bonus_10x', 'bonus_10x', // 10x biraz daha sƒ±k (3 adet - √ñNCE 3 ADETTƒ∞ - AYNI KALDI)
    'bonus_20x', // 20x hala nadir (1 adet - √ñNCE 2 ADETTƒ∞ - AZALTILDI)
    'bonus_50x', // 50x √ßok nadir (1 adet - DEƒûƒ∞≈ûMEDƒ∞)
    'bonus_100x', // 100x ultra nadir (1 adet - DEƒûƒ∞≈ûMEDƒ∞)
    'bonus_1000x' // Efsanevi nadir (1 adet - DEƒûƒ∞≈ûMEDƒ∞)
];

const currencySymbol = 'üí∞';

const numRows = 5;
const numCols = 6;
const numReels = numRows * numCols;

// KAZAN√á √áARPANLARI HAFƒ∞F D√ú≈û√úR√úLD√ú!
const paytable = {
    'zeus': { 3: 4, 4: 15, 5: 80, 6: 400 }, // D√º≈ü√ºr√ºld√º
    'pegasus': { 3: 3, 4: 12, 5: 60, 6: 250 }, // D√º≈ü√ºr√ºld√º
    'eagle': { 3: 2.5, 4: 8, 5: 40, 6: 180 }, // D√º≈ü√ºr√ºld√º
    'helmet': { 3: 1.5, 4: 6, 5: 25, 6: 80 }, // D√º≈ü√ºr√ºld√º
    'vase': { 3: 1.5, 4: 6, 5: 25, 6: 80 }, // D√º≈ü√ºr√ºld√º
    'coin': { 3: 1, 4: 4, 5: 20, 6: 60 }, // D√º≈ü√ºr√ºld√º
    'thunder': { 3: 1, 4: 4, 5: 20, 6: 60 }, // D√º≈ü√ºr√ºld√º
    'cardA': { 3: 0.3, 4: 1.5, 5: 8, 6: 30 }, // D√º≈ü√ºr√ºld√º
    'cardK': { 3: 0.3, 4: 1.5, 5: 8, 6: 30 }, // D√º≈ü√ºr√ºld√º
    'cardQ': { 3: 0.2, 4: 1, 5: 6, 6: 25 }, // D√º≈ü√ºr√ºld√º
    'cardJ': { 3: 0.2, 4: 1, 5: 6, 6: 25 } // D√º≈ü√ºr√ºld√º
};


// G√úNCELLENDƒ∞: SADECE 5 ADET D√úZ YATAY √ñDEME √áƒ∞ZGƒ∞Sƒ∞ (Her satƒ±r bir √ßizgi)
const allPaylines = [
    [0, 1, 2, 3, 4, 5],      // 1. Satƒ±r
    [6, 7, 8, 9, 10, 11],    // 2. Satƒ±r
    [12, 13, 14, 15, 16, 17], // 3. Satƒ±r
    [18, 19, 20, 21, 22, 23], // 4. Satƒ±r
    [24, 25, 26, 27, 28, 29]  // 5. Satƒ±r
];

let activePaylines = JSON.parse(localStorage.getItem('zeusSlotActivePaylines')) || Array.from({ length: allPaylines.length }, (_, i) => i); // Varsayƒ±lan olarak t√ºm √ßizgiler aktif

// Kullanƒ±cƒ± Aray√ºz√ºn√º G√ºncelleme Fonksiyonu
function updateUI() {
    balanceDisplay.textContent = balance.toFixed(2);
    betAmountDisplay.textContent = betAmount;
    freeSpinsCountDisplay.textContent = freeSpins;

    // Otomatik √ßevirme butonu metnini ve durumunu g√ºncelle
    if (isAutoSpinning) {
        autoSpinButton.textContent = `DURDUR (${autoSpinCount - currentAutoSpin}/${autoSpinCount})`;
        autoSpinInput.disabled = true; // Otomatik √ßevirme sƒ±rasƒ±nda inputu devre dƒ±≈üƒ± bƒ±rak
    } else {
        autoSpinButton.textContent = "OTOMATƒ∞K √áEVƒ∞R";
        autoSpinInput.disabled = false;
    }

    if (freeSpins > 0) {
        decreaseBetBtn.disabled = true;
        increaseBetBtn.disabled = true;
        paylineSettingsButton.disabled = true;
        spinButton.disabled = isSpinning; // Free spin sƒ±rasƒ±nda manuel spin hala kontrol edilebilir
        autoSpinInput.disabled = true; // Free spin varken de input devre dƒ±≈üƒ± kalsƒ±n
        autoSpinButton.disabled = isSpinning; // Free spin varken otomatik √ßevirme ba≈ülatƒ±lamaz/durdurulamaz (spin devam ediyorsa)
    } else {
        // Free spin yoksa normal kontrol
        decreaseBetBtn.disabled = isSpinning || isAutoSpinning;
        increaseBetBtn.disabled = isSpinning || isAutoSpinning;
        paylineSettingsButton.disabled = isSpinning || isAutoSpinning;
        spinButton.disabled = isSpinning || isAutoSpinning;
        autoSpinButton.disabled = isSpinning;
    }

    // Kullanƒ±cƒ±nƒ±n bakiyesini users objesinde ve localStorage'da g√ºncelle
    if (activeUser && users[activeUser]) {
        users[activeUser].balance = balance;
        localStorage.setItem('hansellCasinoUsers', JSON.stringify(users));
    }
}

// Reel elementine sembol√º yerle≈ütiren yardƒ±mcƒ± fonksiyon
function setReelSymbol(reelElement, symbolKey) {
    if (symbolKey === currencySymbol) {
        reelElement.innerHTML = currencySymbol;
        reelElement.style.fontSize = '30px';
    } else {
        const img = document.createElement('img');
        img.src = symbolImagesMap.get(symbolKey);
        img.alt = symbolKey;
        reelElement.innerHTML = '';
        reelElement.appendChild(img);
        reelElement.style.fontSize = '';
    }
}

// G√úNCELLENDƒ∞: Rastgele Sembol Alma Fonksiyonu (Olasƒ±lƒ±klar ayarlandƒ±)
function getRandomSymbolKey() {
    const randomChance = Math.random();

    // Free spin durumunda: Hem normal semboller, hem zeus_scatter, hem de √ßarpan sembolleri d√º≈üebilir.
    if (freeSpins > 0) {
        // √áarpan ve Bonus (FS) gelme olasƒ±lƒ±ƒüƒ±nƒ± biraz artƒ±rdƒ±k free spin modunda
        if (randomChance < 0.70) { // %70 ihtimalle normal sembol (√ñNCE %75'Tƒ∞ - AZALTILDI)
            return weightedSymbols[Math.floor(Math.random() * weightedSymbols.length)];
        } else { // %30 ihtimalle bonus sembol√º (FS veya √ßarpan) (√ñNCE %25'Tƒ∞ - ARTIRILDI)
            const bonusTypeChance = Math.random();
            if (bonusTypeChance < 0.55) { // Bu %30'un %55'i (yani toplamda %16.5) Zeus scatter sembol√º (√ñNCE %50'Tƒ∞ - ARTIRILDI)
                return weightedFreeSpinSymbols[Math.floor(Math.random() * weightedFreeSpinSymbols.length)];
            } else { // Bu %30'un %45'i (yani toplamda %13.5) √ßarpan sembol√º (√ñNCE %50'Tƒ∞ - AZALTILDI)
                return weightedMultiplierSymbols[Math.floor(Math.random() * weightedMultiplierSymbols.length)];
            }
        }
    } else { // Normal spin durumunda: Sadece normal semboller ve zeus_scatter sembol√º d√º≈üebilir, √ßarpanlar D√ú≈ûMEZ.
        // Bonus (Free Spin) gelme olasƒ±lƒ±ƒüƒ±nƒ± daha da arttƒ±rdƒ±k (%3'ten %5'e)
        if (randomChance < 0.95) { // %95 ihtimalle normal sembol (√ñNCE %97'Tƒ∞ - AZALTILDI)
            return weightedSymbols[Math.floor(Math.random() * weightedSymbols.length)];
        } else { // %5 ihtimalle zeus_scatter sembol√º (√ñNCE %3'T√ú - ARTIRILDI)
            return weightedFreeSpinSymbols[Math.floor(Math.random() * weightedFreeSpinSymbols.length)];
        }
    }
}


// Makaralarƒ± D√∂nd√ºrme Fonksiyonu
function spinReels() {
    if (isSpinning) {
        return;
    }

    if (freeSpins === 0 && balance < betAmount) {
        messageDisplay.textContent = 'Bakiyen Yetersiz! Bahsi Azalt.';
        stopAutoSpin(); // Otomatik √ßevirme a√ßƒ±ksa durdur
        return;
    }

    winAmountDisplay.textContent = '';
    messageDisplay.textContent = '';
    removeHighlight();
    resetReelSymbols(); // Yeni spin √∂ncesi makaralarƒ± sƒ±fƒ±rla

    if (highlightTimeout) clearTimeout(highlightTimeout);
    if (symbolResetTimeout) clearTimeout(symbolResetTimeout);


    if (freeSpins === 0) {
        balance -= betAmount;
    } else {
        freeSpins--;
    }

    updateUI();

    if (freeSpins > 0) {
        messageDisplay.textContent = `FREE SPIN! Kalan: ${freeSpins}`;
        messageDisplay.style.color = '#FFD700';
    } else {
        messageDisplay.textContent = 'D√∂n√ºyor...';
        messageDisplay.style.color = '#B22222';
    }

    spinButton.disabled = true;
    autoSpinButton.disabled = true; // Otomatik √ßevirme butonunu da spin sƒ±rasƒ±nda devre dƒ±≈üƒ± bƒ±rak
    isSpinning = true;

    if (!isMuted) {
        spinSound.currentTime = 0;
        spinSound.play();
    }

    let currentSymbols = new Array(numReels);
    lastSpinSymbols = [];
    let spinningIntervals = [];
    let stoppedReelsCount = 0;

    reels.forEach((reel, index) => {
        const spinDuration = 1500 + (index * 60);
        const spinInterval = 70;

        spinningIntervals[index] = setInterval(() => {
            setReelSymbol(reel, getRandomSymbolKey());
        }, spinInterval);

        setTimeout(() => {
            clearInterval(spinningIntervals[index]);
            const finalSymbolKey = getRandomSymbolKey();
            currentSymbols[index] = finalSymbolKey;
            lastSpinSymbols[index] = finalSymbolKey;
            setReelSymbol(reel, finalSymbolKey);
            stoppedReelsCount++;

            if (stoppedReelsCount === numReels) {
                spinSound.pause();
                spinSound.currentTime = 0;
                checkWin(currentSymbols);
                isSpinning = false; // Spin biti≈üi
                updateUI(); // Buton durumlarƒ±nƒ± g√ºncelle

                // Otomatik √ßevirme mantƒ±ƒüƒ±
                if (isAutoSpinning) {
                    currentAutoSpin++;
                    if (freeSpins > 0 || currentAutoSpin < autoSpinCount) {
                        // Eƒüer free spin varsa veya otomatik √ßevirme sayƒ±sƒ± bitmediyse devam et
                        autoSpinTimeout = setTimeout(spinReels, 2500); // Kazanma mesajƒ±/animasyonu sonrasƒ± bekle ve tekrar √ßevir
                    } else {
                        // Otomatik √ßevirme sayƒ±sƒ± bittiƒüinde durdur
                        stopAutoSpin();
                        messageDisplay.textContent = `Otomatik √ßevirme tamamlandƒ±!`;
                        messageDisplay.style.color = '#4CAF50';
                    }
                }
            }
        }, spinDuration);
    });
}

// Otomatik √ßevirmeyi ba≈ülat/durdur
function toggleAutoSpin() {
    if (isAutoSpinning) {
        stopAutoSpin();
    } else {
        startAutoSpin();
    }
}

function startAutoSpin() {
    if (isSpinning) return; // Manuel spin varsa ba≈ülatma

    autoSpinCount = parseInt(autoSpinInput.value);
    if (isNaN(autoSpinCount) || autoSpinCount <= 0) {
        messageDisplay.textContent = 'L√ºtfen ge√ßerli bir otomatik √ßevirme sayƒ±sƒ± girin (min 1).';
        messageDisplay.style.color = '#B22222';
        return;
    }

    // Yetersiz bakiye kontrol√º (sadece normal spinler i√ßin)
    if (freeSpins === 0 && balance < betAmount * autoSpinCount) {
        messageDisplay.textContent = `Otomatik √ßevirme i√ßin yeterli bakiyen yok! (${(betAmount * autoSpinCount).toFixed(2)} TL gerekli)`;
        messageDisplay.style.color = '#B22222';
        return;
    }

    isAutoSpinning = true;
    currentAutoSpin = 0; // Her ba≈ülatƒ±ldƒ±ƒüƒ±nda sayacƒ± sƒ±fƒ±rla
    updateUI(); // Buton durumlarƒ±nƒ± g√ºncelle

    // ƒ∞lk √ßevirmeyi ba≈ülat
    spinReels();
}

function stopAutoSpin() {
    isAutoSpinning = false;
    clearTimeout(autoSpinTimeout); // Bekleyen √ßevirme varsa iptal et
    updateUI(); // Buton durumlarƒ±nƒ± g√ºncelle (OTOMATƒ∞K √áEVƒ∞R yazƒ±sƒ± gelsin)
    messageDisplay.textContent = 'Otomatik √ßevirme durduruldu.';
    messageDisplay.style.color = '#B22222';
}


// G√úNCELLENDƒ∞: Kazan√ßlarƒ± Kontrol Eden Fonksiyon (Line Sistemi - Sadece D√ºz √áizgiler ve Artƒ±k Biti≈üik Kazan√ßlarƒ± da Tanƒ±yor)
function checkWin(resultSymbols) {
    let totalWin = 0;
    let totalMultiplier = 1;
    let overallWinningReelIndexes = new Set();
    let zeusScatterSymbolCount = 0;
    const zeusScatterSymbolIndexes = [];
    const collectedMultiplierBonuses = [];

    // Bonus sembollerini topla (free spin sembolleri ve √ßarpanlar)
    resultSymbols.forEach((symbolKey, index) => {
        if (symbolKey === 'zeus_scatter') {
            zeusScatterSymbolCount++;
            zeusScatterSymbolIndexes.push(index);
        } else {
            const symbolData = symbols.find(s => s.id === symbolKey);
            // Sadece free spin modunda √ßarpanlarƒ± topla
            if (freeSpins > 0 && symbolData && symbolData.multiplier) {
                collectedMultiplierBonuses.push(symbolData.multiplier);
            }
        }
    });

    // Free Spin Bonusu Tetiklemesi (4 veya daha fazla zeus_scatter sembol√º)
    if (zeusScatterSymbolCount >= 4) {
        const initialFreeSpins = 10;
        freeSpins += initialFreeSpins;
        messageDisplay.textContent = `ZEUS'UN L√úTFU! ${initialFreeSpins} FREE SPIN KAZANDIN! ‚ö°`;
        messageDisplay.style.color = '#FFD700';
        if (!isMuted) {
            winSound.pause();
            winSound.currentTime = 0;
            bonusSound.currentTime = 0;
            bonusSound.play();
        }
        highlightWinningReels(zeusScatterSymbolIndexes);
        updateUI();
        // Eƒüer otomatik √ßevirme a√ßƒ±ksa, free spin tetiklendiƒüinde otomatik √ßevirmeye devam et
        if (isAutoSpinning) {
            setTimeout(spinReels, 2500); // Bonus animasyonu sonrasƒ± devam et
        }
        return; // Free spin tetiklenirse, normal kazan√ß kontrol√ºn√º yapma
    }

    // Normal sembol kazan√ßlarƒ±nƒ± kontrol et (aktif √∂deme √ßizgileri √ºzerinde)
    activePaylines.forEach(paylineIndex => {
        const payline = allPaylines[paylineIndex];
        if (!payline) return;

        // Her √∂deme √ßizgisi i√ßin sembolleri satƒ±r olarak al
        const lineSymbols = payline.map(index => resultSymbols[index]);

        let currentSymbol = '';
        let currentStreak = 0;
        let lineWinningIndexes = []; // Bu √ßizgi i√ßin kazanan indexler

        for (let i = 0; i < lineSymbols.length; i++) {
            const symbolOnReel = lineSymbols[i];
            const originalReelIndex = payline[i]; // Reel'in orijinal global indeksi

            // Bonus sembolleri kazan√ß √ßizgisi olarak kabul edilmez, ancak √ßarpan olarak i≈ülenebilir.
            // Bu kƒ±sƒ±mda sadece ana sembollerin e≈üle≈ümesine bakƒ±yoruz.
            if (symbolOnReel.startsWith('bonus_') || symbolOnReel === 'zeus_scatter') {
                // Eƒüer streak varsa ve bonus sembol√º geldiyse, streak'i bitirip kontrol et
                if (currentStreak >= 3 && paytable[currentSymbol] && paytable[currentSymbol][currentStreak]) {
                    const multiplier = paytable[currentSymbol][currentStreak];
                    const lineWin = betAmount * multiplier;
                    totalWin += lineWin;
                    lineWinningIndexes.forEach(idx => overallWinningReelIndexes.add(idx));
                }
                currentSymbol = ''; // Streaki sƒ±fƒ±rla
                currentStreak = 0;
                lineWinningIndexes = [];
                continue; // Bir sonraki sembole ge√ß
            }

            if (symbolOnReel === currentSymbol) {
                currentStreak++;
                lineWinningIndexes.push(originalReelIndex);
            } else {
                // Yeni bir sembol ba≈üladƒ±ysa veya streak bozulduysa, √∂nceki streaki kontrol et
                if (currentStreak >= 3 && paytable[currentSymbol] && paytable[currentSymbol][currentStreak]) {
                    const multiplier = paytable[currentSymbol][currentStreak];
                    const lineWin = betAmount * multiplier;
                    totalWin += lineWin;
                    lineWinningIndexes.forEach(idx => overallWinningReelIndexes.add(idx));
                }
                // Yeni streaki ba≈ülat
                currentSymbol = symbolOnReel;
                currentStreak = 1;
                lineWinningIndexes = [originalReelIndex];
            }
        }

        // D√∂ng√º bittikten sonra kalan son streaki kontrol et (eƒüer varsa)
        if (currentStreak >= 3 && paytable[currentSymbol] && paytable[currentSymbol][currentStreak]) {
            const multiplier = paytable[currentSymbol][currentStreak];
            const lineWin = betAmount * multiplier;
            totalWin += lineWin;
            lineWinningIndexes.forEach(idx => overallWinningReelIndexes.add(idx));
        }
    });

    // Toplanmƒ±≈ü √ßarpanlarƒ± kazanca uygula (sadece kazan√ß varsa VE free spin modundaysak)
    if (totalWin > 0 && freeSpins > 0 && collectedMultiplierBonuses.length > 0) {
        // Free spin sƒ±rasƒ±nda √ßarpan gelme olasƒ±lƒ±ƒüƒ± d√º≈ü√ºr√ºld√º, bu da √ßarpanƒ±n kendisinin daha nadir gelmesi anlamƒ±na gelir.
        // Ama geldiklerinde √ßarpƒ±mƒ± yine de yapmalƒ±yƒ±z.
        const combinedMultiplier = collectedMultiplierBonuses.reduce((sum, current) => sum + current, 0);
        if (combinedMultiplier > 0) {
            totalWin *= combinedMultiplier;
            totalMultiplier = combinedMultiplier;
        }
    } else {
        totalMultiplier = 1;
    }

    // Kazan√ß durumunu g√∂ster
    if (totalWin > 0) {
        balance += totalWin;
        messageDisplay.textContent = `TEBRƒ∞KLER! KAZANDIN! üéâ`;
        messageDisplay.style.color = '#DAA520';
        let winText = `Bakiyene ${totalWin.toFixed(2)} TL Eklendi!`;
        if (totalMultiplier > 1 && freeSpins > 0) {
            winText += ` (${totalMultiplier}x √áarpan ile!)`;
        }
        winAmountDisplay.textContent = winText;
        if (!isMuted) {
            winSound.currentTime = 0;
            winSound.play();
        }
        highlightWinningReels(Array.from(overallWinningReelIndexes));
        transformWinningSymbols(Array.from(overallWinningReelIndexes));
    } else {
        messageDisplay.textContent = 'Tekrar Dene! ≈ûansƒ±nƒ± Bir Sonraki √áevirmede Yakala. üçÄ';
        messageDisplay.style.color = '#B22222';
        winAmountDisplay.textContent = '';
    }
    updateUI();
}

// Kazanan makaralarƒ±n arka planƒ±nƒ± ge√ßici olarak parlatma
function highlightWinningReels(winningReelIndexes) {
    if (highlightTimeout) {
        clearTimeout(highlightTimeout);
        removeHighlight();
    }

    winningReelIndexes.forEach(index => {
        reels[index].classList.add('highlight');
    });

    highlightTimeout = setTimeout(() => {
        removeHighlight();
    }, 2000);
}

// Makaralardan parlaklƒ±ƒüƒ± kaldƒ±ran fonksiyon
function removeHighlight() {
    reels.forEach(reel => {
        reel.classList.remove('highlight');
    });
}

// Kazanan sembolleri para simgesine √ßevir
function transformWinningSymbols(winningReelIndexes) {
    winningReelIndexes.forEach(index => {
        setReelSymbol(reels[index], currencySymbol);
    });

    if (symbolResetTimeout) clearTimeout(symbolResetTimeout);
    symbolResetTimeout = setTimeout(() => {
        // Para sembollerini √∂nceki hallerine d√∂nd√ºr, kazan√ß hattƒ± temizlendikten sonra
        resetReelSymbols();
    }, 1500);
}

// T√ºm makaralarƒ±n sembollerini ba≈ülangƒ±√ß durumuna (son √ßevirmedeki semboller) d√∂nd√ºr
function resetReelSymbols() {
    reels.forEach((reel, index) => {
        if (lastSpinSymbols[index]) {
            setReelSymbol(reel, lastSpinSymbols[index]);
        } else {
            // Eƒüer lastSpinSymbols bo≈üsa (oyun ilk ba≈üladƒ±ƒüƒ±nda), rastgele sembol ata
            setReelSymbol(reel, getRandomSymbolKey());
        }
        reel.classList.remove('highlight');
    });
}

// Paytable bilgisini popup men√ºye doldur
function populatePaytableInfo() {
    paytableInfoDisplay.innerHTML = '';

    // Bonus sembollerini dƒ±≈üarƒ±da bƒ±rakƒ±p sƒ±ralƒ± bir ≈üekilde sembolleri al
    const regularSymbols = symbols.filter(s => !s.id.startsWith('bonus_') && s.id !== 'zeus_scatter');

    // Sembolleri deƒüerine g√∂re b√ºy√ºkten k√º√ß√ºƒüe sƒ±rala (daha deƒüerli olanlar √ºstte)
    regularSymbols.sort((a, b) => b.value - a.value);

    regularSymbols.forEach(symbol => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('paytable-item');

        const img = document.createElement('img');
        img.src = symbol.img;
        img.alt = symbol.id;
        itemDiv.appendChild(img);

        const title = document.createElement('h4');
        title.textContent = symbol.id.charAt(0).toUpperCase() + symbol.id.slice(1).replace('card', 'Kart '); // "cardA" -> "Kart A"
        itemDiv.appendChild(title);

        const ul = document.createElement('ul');
        const symbolPaytable = paytable[symbol.id];
        if (symbolPaytable) {
            for (const count in symbolPaytable) {
                if (symbolPaytable.hasOwnProperty(count)) {
                    const li = document.createElement('li');
                    li.textContent = `${count}x: ${symbolPaytable[count]} Kat`;
                    ul.appendChild(li);
                }
            }
        }
        itemDiv.appendChild(ul);
        paytableInfoDisplay.appendChild(itemDiv);
    });
}

// YENƒ∞: √ñdeme √ßizgisi ayarlarƒ± popup'ƒ±nƒ± doldur
function populatePaylineSettings() {
    paylineOptionsGrid.innerHTML = ''; // √ñnceki se√ßenekleri temizle

    allPaylines.forEach((payline, index) => {
        const optionDiv = document.createElement('div');
        optionDiv.classList.add('payline-option');

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `payline-${index}`;
        checkbox.value = index;
        checkbox.checked = activePaylines.includes(index); // Kullanƒ±cƒ±nƒ±n aktif √ßizgilerine g√∂re i≈üaretle

        const label = document.createElement('label');
        label.htmlFor = `payline-${index}`;
        label.textContent = `√áizgi ${index + 1} (D√ºz)`; // 1'den ba≈ülayarak g√∂ster ve "D√ºz" ekle

        optionDiv.appendChild(checkbox);
        optionDiv.appendChild(label);
        paylineOptionsGrid.appendChild(optionDiv);
    });
}

// Ses a√ßma/kapama fonksiyonu
function toggleMute() {
    isMuted = !isMuted;

    if (isMuted) {
        backgroundMusic.pause();
        muteButton.textContent = 'üîä';
    } else {
        backgroundMusic.play().catch(e => {
            console.log("M√ºzik yeniden ba≈ülatƒ±lamadƒ±:", e);
        });
        muteButton.textContent = 'üîá';
    }
}


// Bahis azaltma butonu olay dinleyicisi
decreaseBetBtn.addEventListener('click', () => {
    if (betAmount > 10 && !isSpinning && freeSpins === 0 && !isAutoSpinning) {
        betAmount -= 10;
        updateUI();
    }
});

// Bahis artƒ±rma butonu olay dinleyicisi
increaseBetBtn.addEventListener('click', () => {
    if (betAmount < 1000 && !isSpinning && freeSpins === 0 && !isAutoSpinning) {
        betAmount += 10;
        updateUI();
    }
});

// Bilgi butonu olay dinleyicileri
infoButton.addEventListener('click', () => {
    populatePaytableInfo();
    infoPopup.style.display = 'block';
});

closeInfoPopupBtn.addEventListener('click', () => {
    infoPopup.style.display = 'none';
});

// Popup dƒ±≈üƒ±na tƒ±klayƒ±nca kapatma
window.addEventListener('click', (event) => {
    if (event.target === infoPopup) {
        infoPopup.style.display = 'none';
    }
    if (event.target === paylineSettingsPopup) {
        paylineSettingsPopup.style.display = 'none';
    }
});

// Mute butonu olay dinleyicisi
muteButton.addEventListener('click', toggleMute);

// Geri D√∂n butonu olay dinleyicisi
backToLobbyButton.addEventListener('click', () => {
    window.location.href = '../lobby.html'; // Lobiye geri d√∂n
});

// YENƒ∞: √ñdeme √ßizgisi ayarlarƒ± butonu olay dinleyicileri
paylineSettingsButton.addEventListener('click', () => {
    if (isSpinning || isAutoSpinning) return; // √áevirme sƒ±rasƒ±nda ayar yapƒ±lamaz
    populatePaylineSettings(); // Ayarlarƒ± doldur
    paylineSettingsPopup.style.display = 'block';
});

closePaylineSettingsPopupBtn.addEventListener('click', () => {
    paylineSettingsPopup.style.display = 'none';
});

savePaylineSettingsBtn.addEventListener('click', () => {
    const selectedPaylines = [];
    document.querySelectorAll('#paylineOptions input[type="checkbox"]:checked').forEach(checkbox => {
        selectedPaylines.push(parseInt(checkbox.value));
    });

    if (selectedPaylines.length === 0) {
        alert('En az bir √∂deme √ßizgisi se√ßmelisin!');
        return;
    }

    activePaylines = selectedPaylines;
    localStorage.setItem('zeusSlotActivePaylines', JSON.stringify(activePaylines));
    paylineSettingsPopup.style.display = 'none';
    messageDisplay.textContent = `√ñdeme √ßizgileri g√ºncellendi: ${activePaylines.length} aktif.`;
    messageDisplay.style.color = '#4CAF50';
});


// --- Sayfa Y√ºklendiƒüinde Ba≈ülangƒ±√ß ƒ∞≈ülemleri ---
document.addEventListener('DOMContentLoaded', () => {
    spinButton.addEventListener('click', spinReels);
    autoSpinButton.addEventListener('click', toggleAutoSpin); // Otomatik √ßevirme butonu olay dinleyicisi

    reels.forEach((reel, index) => {
        const initialSymbol = getRandomSymbolKey();
        setReelSymbol(reel, initialSymbol);
        lastSpinSymbols[index] = initialSymbol;
    });

    updateUI(); // Sayfa ilk y√ºklendiƒüinde bakiyeyi g√∂ster ve localStorage'dan √ßek

    // Tarayƒ±cƒ± kƒ±sƒ±tlamalarƒ± nedeniyle otomatik oynatma her zaman √ßalƒ±≈ümayabilir.
    // Kullanƒ±cƒ± etkile≈üimi olmadan ses ba≈ülamazsa hata vermemesi i√ßin catch bloƒüu eklendi.
    // M√ºzik ancak kullanƒ±cƒ± sayfaya tƒ±kladƒ±ktan sonra ba≈ülayacaktƒ±r.
    backgroundMusic.play().catch(e => {
        console.log("Arkaplan m√ºziƒüi otomatik oynatƒ±lamadƒ± (tarayƒ±cƒ± kƒ±sƒ±tlamasƒ±):", e);
        messageDisplay.textContent = "M√ºziƒüi ba≈ülatmak i√ßin spin butonuna tƒ±klayƒ±n veya ekrana dokunun.";
    });
});
